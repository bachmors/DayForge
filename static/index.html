<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DayForge ‚Äî Forja tu D√≠a</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700;800;900&family=IBM+Plex+Sans:wght@300;400;500;600&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
:root{--purple:#6C5CE7;--purple-light:#a855f7;--purple-dark:#4a3aa0;--orange:#FD7014;--green:#00B894;--red:#e74c3c;--bg-dark:#0a0a1a;--bg-card:#12122a;--bg-sidebar:#0e0e22;--border:rgba(108,92,231,0.2);--text:#e8e8f0;--text-dim:#8888aa;--text-bright:#fff;--hyp-bg:rgba(168,85,247,0.08);--hyp-border:rgba(168,85,247,0.25)}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'IBM Plex Sans',sans-serif;background:var(--bg-dark);color:var(--text);min-height:100vh}
body::before{content:'';position:fixed;top:-50%;left:-50%;width:200%;height:200%;background:radial-gradient(ellipse at 20% 20%,rgba(108,92,231,0.06) 0%,transparent 50%),radial-gradient(ellipse at 80% 80%,rgba(253,112,20,0.04) 0%,transparent 50%);pointer-events:none;z-index:0}

/* LOGIN */
#loginScreen{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100vh;position:relative;z-index:1}
.login-box{background:var(--bg-card);border:1px solid var(--border);border-radius:20px;padding:48px 40px;width:380px;text-align:center}
.login-box h1{font-family:'Playfair Display',serif;font-weight:800;font-size:2.4rem;background:linear-gradient(135deg,var(--purple-light),var(--orange));-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:8px}
.login-box .sub{color:var(--text-dim);font-size:0.9rem;margin-bottom:32px;font-weight:300}
.login-box input{width:100%;padding:12px 16px;background:var(--bg-dark);border:1px solid var(--border);border-radius:10px;color:var(--text);font-family:inherit;font-size:0.95rem;margin-bottom:12px;outline:none}
.login-box input:focus{border-color:var(--purple)}
.login-box button{width:100%;padding:12px;background:linear-gradient(135deg,var(--purple),var(--purple-dark));color:white;border:none;border-radius:10px;font-weight:600;font-size:1rem;cursor:pointer;margin-top:8px}
.login-error{color:var(--red);font-size:0.85rem;margin-top:12px;min-height:20px}

/* APP */
#appScreen{display:none;position:relative;z-index:1;height:100vh}
.header{display:flex;align-items:center;justify-content:space-between;padding:10px 20px;border-bottom:1px solid var(--border);background:rgba(10,10,26,0.9);backdrop-filter:blur(12px);position:sticky;top:0;z-index:100;height:50px}
.header-left{display:flex;align-items:center;gap:12px}
.header-logo{font-family:'Playfair Display',serif;font-weight:800;font-size:1.3rem;background:linear-gradient(135deg,var(--purple-light),var(--orange));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.header-right{display:flex;align-items:center;gap:10px}
.dev-st{display:flex;align-items:center;gap:6px;font-size:0.75rem;color:var(--text-dim);font-family:'JetBrains Mono',monospace}
.dev-dot{width:8px;height:8px;border-radius:50%;background:var(--green);animation:pulse 2s infinite}
.dev-dot.off{background:var(--red);animation:none}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.4}}
.hdr-btn{background:none;border:1px solid var(--border);color:var(--text-dim);padding:4px 10px;border-radius:6px;font-size:0.75rem;cursor:pointer;transition:all 0.2s;position:relative;font-family:inherit}
.hdr-btn:hover{border-color:var(--purple);color:var(--text)}
.badge{position:absolute;top:-6px;right:-6px;background:var(--orange);color:white;font-size:0.6rem;width:16px;height:16px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:600}

/* GRID */
.app-grid{display:grid;grid-template-columns:240px 1fr;height:calc(100vh - 50px);overflow:hidden}

/* SIDEBAR */
.sidebar{background:var(--bg-sidebar);border-right:1px solid var(--border);overflow-y:auto;padding:16px 0}
.sb-sec{padding:0 14px;margin-bottom:18px}
.sb-title{font-family:'JetBrains Mono',monospace;font-size:0.65rem;color:var(--text-dim);text-transform:uppercase;letter-spacing:1.5px;margin-bottom:8px;padding:0 4px}
.sb-ws{display:flex;align-items:center;gap:8px;padding:7px 10px;border-radius:8px;cursor:pointer;transition:all 0.15s;font-size:0.87rem;position:relative}
.sb-ws:hover{background:rgba(255,255,255,0.04)}
.sb-ws.active{background:rgba(108,92,231,0.15);color:var(--text-bright)}
.sb-ws .icon{font-size:1.1rem}
.sb-ws .name{flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.sb-ws .cnt{font-family:'JetBrains Mono',monospace;font-size:0.65rem;color:var(--text-dim);background:rgba(255,255,255,0.05);padding:2px 6px;border-radius:4px}
.sb-ws .fire{position:absolute;right:4px;top:4px;font-size:0.7rem}
.sb-add{display:flex;align-items:center;gap:8px;padding:5px 10px;border-radius:8px;cursor:pointer;color:var(--text-dim);font-size:0.82rem;transition:all 0.15s}
.sb-add:hover{background:rgba(255,255,255,0.04);color:var(--purple-light)}

/* Sidebar pins */
.sb-pin{display:flex;align-items:center;gap:6px;padding:4px 10px;border-radius:6px;font-size:0.78rem;color:var(--text-dim);transition:all 0.15s;cursor:pointer}
.sb-pin:hover{background:rgba(255,255,255,0.04);color:var(--text)}
.sb-pin .lbl{flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;text-decoration:none;color:inherit}
.sb-pin .acts{display:flex;gap:2px;opacity:0;transition:opacity 0.15s}
.sb-pin:hover .acts{opacity:1}
.pbtn{background:none;border:none;color:var(--text-dim);cursor:pointer;font-size:0.7rem;padding:2px}
.pbtn:hover{color:var(--purple-light)}

/* Sidebar apps */
.sb-app{display:flex;align-items:center;gap:8px;padding:5px 10px;border-radius:8px;cursor:pointer;font-size:0.83rem;transition:all 0.15s}
.sb-app:hover{background:rgba(255,255,255,0.04)}
.achk{width:16px;height:16px;border:2px solid var(--border);border-radius:4px;display:flex;align-items:center;justify-content:center;font-size:0.65rem;color:transparent;transition:all 0.2s;flex-shrink:0}
.achk.on{background:var(--green);border-color:var(--green);color:white}
.sb-app .nm{flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.sb-app .dl{background:none;border:none;color:var(--text-dim);cursor:pointer;font-size:0.7rem;opacity:0;transition:opacity 0.15s}
.sb-app:hover .dl{opacity:1}
.sb-launch{display:block;width:calc(100% - 8px);margin:8px 4px 0;padding:7px;background:linear-gradient(135deg,var(--orange),#e85d04);color:white;border:none;border-radius:8px;font-family:inherit;font-weight:600;font-size:0.83rem;cursor:pointer;transition:all 0.2s}
.sb-launch:disabled{opacity:0.3;cursor:not-allowed}
.sb-row{display:flex;gap:4px;margin-top:6px;padding:0 4px}
.sb-row input{flex:1;padding:5px 8px;background:var(--bg-dark);border:1px solid var(--border);border-radius:6px;color:var(--text);font-size:0.73rem;font-family:inherit;outline:none}
.sb-row button{padding:5px 8px;background:var(--purple);color:white;border:none;border-radius:6px;font-size:0.73rem;cursor:pointer}

/* CONTENT */
.content{overflow-y:auto;padding:20px 28px;position:relative}

/* Hypatia observe */
.hyp-panel{background:var(--hyp-bg);border:1px solid var(--hyp-border);border-radius:14px;padding:12px 16px;margin-bottom:18px;display:flex;align-items:flex-start;gap:12px;animation:breathe 4s ease-in-out infinite}
@keyframes breathe{0%,100%{border-color:rgba(168,85,247,0.25)}50%{border-color:rgba(168,85,247,0.45)}}
.hyp-av{width:34px;height:34px;background:linear-gradient(135deg,var(--purple),#ec4899);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:1rem;flex-shrink:0}
.hyp-panel .body{flex:1}
.hyp-panel .lab{font-family:'JetBrains Mono',monospace;font-size:0.6rem;color:var(--purple-light);text-transform:uppercase;letter-spacing:1px;margin-bottom:3px}
.hyp-panel .msg{font-size:0.88rem;line-height:1.5;font-weight:300}
.hyp-panel .rf{background:none;border:none;color:var(--purple-light);cursor:pointer;font-size:1rem;opacity:0.5;transition:opacity 0.2s;flex-shrink:0}
.hyp-panel .rf:hover{opacity:1}

/* Workspace header */
.ws-hdr{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;flex-wrap:wrap;gap:8px}
.ws-hdr-left{display:flex;align-items:center;gap:10px}
.ws-hdr-left .ic{font-size:1.4rem}
.ws-hdr-left h2{font-family:'Playfair Display',serif;font-weight:700;font-size:1.25rem}
.ws-hdr-right{display:flex;gap:6px}
.wb{background:none;border:1px solid var(--border);color:var(--text-dim);padding:4px 10px;border-radius:7px;font-size:0.76rem;cursor:pointer;font-family:inherit;transition:all 0.2s}
.wb:hover{border-color:var(--purple);color:var(--text)}
.wb.fon{border-color:var(--orange);color:var(--orange)}

/* Categories / filter bar */
.cat-bar{display:flex;gap:6px;margin-bottom:14px;flex-wrap:wrap;align-items:center}
.cat-pill{padding:4px 12px;border-radius:16px;font-size:0.78rem;cursor:pointer;transition:all 0.2s;border:1px solid var(--border);background:none;color:var(--text-dim);font-family:inherit}
.cat-pill:hover{border-color:var(--purple);color:var(--text)}
.cat-pill.on{background:rgba(108,92,231,0.2);border-color:var(--purple);color:var(--purple-light)}
.cat-pill .cnt{font-family:'JetBrains Mono',monospace;font-size:0.6rem;margin-left:4px;opacity:0.6}

/* Items */
.itm-label{font-family:'JetBrains Mono',monospace;font-size:0.65rem;color:var(--text-dim);text-transform:uppercase;letter-spacing:1px;margin-bottom:6px;margin-top:12px}
.itm{display:flex;align-items:center;gap:8px;padding:8px 10px;border-radius:8px;transition:background 0.15s}
.itm:hover{background:rgba(255,255,255,0.03)}
.itm.done{opacity:0.35}
.ichk{width:17px;height:17px;border:2px solid var(--border);border-radius:5px;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:all 0.2s;color:transparent;font-size:0.65rem}
.ichk:hover{border-color:var(--green)}
.ichk.on{background:var(--green);border-color:var(--green);color:white}
.itm .tp{font-size:0.85rem;flex-shrink:0}
.itm .lb{flex:1;font-size:0.86rem;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;cursor:pointer}
.itm .lb:hover{color:var(--purple-light)}
.itm.done .lb{text-decoration:line-through;cursor:default}
.itm .vl{font-family:'JetBrains Mono',monospace;font-size:0.63rem;color:var(--text-dim);max-width:160px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.itm .nt{font-size:0.72rem;color:var(--purple-light);max-width:120px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;font-style:italic}
.itm .iacts{display:flex;gap:2px;opacity:0;transition:opacity 0.15s}
.itm:hover .iacts{opacity:1}
.ib{background:none;border:none;color:var(--text-dim);cursor:pointer;font-size:0.78rem;padding:2px 3px;transition:color 0.15s}
.ib:hover{color:var(--purple-light)}
.ib.del:hover{color:var(--red)}

/* Add item */
.add-row{display:flex;gap:5px;margin-top:10px;padding-top:10px;border-top:1px solid rgba(108,92,231,0.1)}
.add-row select,.add-row input{padding:6px 9px;background:var(--bg-dark);border:1px solid var(--border);border-radius:7px;color:var(--text);font-family:inherit;font-size:0.8rem;outline:none}
.add-row select{width:82px}
.add-row input{flex:1}
.add-row input:focus,.add-row select:focus{border-color:var(--purple)}
.add-row button{padding:6px 12px;background:var(--purple);color:white;border:none;border-radius:7px;font-weight:600;font-size:0.8rem;cursor:pointer;white-space:nowrap}

/* Forge */
.forge-sec{text-align:center;margin:24px 0 14px}
.forge-btn{padding:13px 40px;background:linear-gradient(135deg,var(--orange),#e85d04);color:white;border:none;border-radius:12px;font-family:'Playfair Display',serif;font-weight:800;font-size:1.15rem;cursor:pointer;transition:all 0.3s;box-shadow:0 4px 24px rgba(253,112,20,0.3)}
.forge-btn:hover{transform:translateY(-2px);box-shadow:0 8px 32px rgba(253,112,20,0.5)}
.forge-cnt{font-family:'JetBrains Mono',monospace;font-size:0.73rem;color:var(--text-dim);margin-top:6px}

/* Empty */
.empty{text-align:center;padding:60px 20px;color:var(--text-dim)}
.empty .ic{font-size:3rem;margin-bottom:12px}
.empty p{font-size:0.9rem;font-weight:300;line-height:1.6}

/* CHAT PANEL */
.chat-toggle{position:fixed;bottom:20px;right:20px;width:50px;height:50px;border-radius:50%;background:linear-gradient(135deg,var(--purple),#ec4899);border:none;color:white;font-size:1.3rem;cursor:pointer;z-index:150;box-shadow:0 4px 20px rgba(108,92,231,0.4);transition:all 0.3s;display:flex;align-items:center;justify-content:center}
.chat-toggle:hover{transform:scale(1.1)}
.chat-panel{position:fixed;bottom:80px;right:20px;width:380px;max-height:500px;background:var(--bg-card);border:1px solid var(--hyp-border);border-radius:16px;z-index:150;display:none;flex-direction:column;overflow:hidden;box-shadow:0 8px 40px rgba(0,0,0,0.5)}
.chat-panel.open{display:flex}
.chat-hdr{display:flex;align-items:center;gap:10px;padding:12px 16px;border-bottom:1px solid var(--border);background:rgba(168,85,247,0.06)}
.chat-hdr .av{width:28px;height:28px;background:linear-gradient(135deg,var(--purple),#ec4899);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:0.8rem;flex-shrink:0}
.chat-hdr .title{flex:1;font-weight:600;font-size:0.9rem}
.chat-hdr select{padding:3px 6px;background:var(--bg-dark);border:1px solid var(--border);border-radius:6px;color:var(--text);font-size:0.72rem;max-width:130px}
.chat-hdr .close{background:none;border:none;color:var(--text-dim);cursor:pointer;font-size:1rem}
.chat-body{flex:1;overflow-y:auto;padding:12px;max-height:340px;min-height:200px}
.chat-msg{margin-bottom:10px;max-width:90%}
.chat-msg.user{margin-left:auto;text-align:right}
.chat-msg .bubble{display:inline-block;padding:8px 12px;border-radius:12px;font-size:0.84rem;line-height:1.4}
.chat-msg.user .bubble{background:rgba(108,92,231,0.2);border:1px solid rgba(108,92,231,0.3)}
.chat-msg.hyp .bubble{background:rgba(168,85,247,0.1);border:1px solid var(--hyp-border)}
.chat-msg .who{font-size:0.6rem;color:var(--text-dim);margin-bottom:2px;font-family:'JetBrains Mono',monospace}
.chat-input-row{display:flex;gap:6px;padding:10px 12px;border-top:1px solid var(--border)}
.chat-input-row input{flex:1;padding:8px 12px;background:var(--bg-dark);border:1px solid var(--border);border-radius:8px;color:var(--text);font-family:inherit;font-size:0.85rem;outline:none}
.chat-input-row input:focus{border-color:var(--purple)}
.chat-input-row button{padding:8px 14px;background:var(--purple);color:white;border:none;border-radius:8px;font-weight:600;font-size:0.85rem;cursor:pointer}
.chat-typing{padding:8px 12px;font-size:0.78rem;color:var(--purple-light);font-style:italic;display:none}

/* MODALS */
.mbg{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.6);backdrop-filter:blur(4px);z-index:200;align-items:center;justify-content:center}
.mbg.on{display:flex}
.modal{background:var(--bg-card);border:1px solid var(--border);border-radius:18px;padding:28px;width:440px;max-width:92vw;max-height:85vh;overflow-y:auto}
.modal h2{font-family:'Playfair Display',serif;font-weight:700;font-size:1.15rem;margin-bottom:16px}
.modal label{display:block;font-size:0.78rem;color:var(--text-dim);margin-bottom:4px;margin-top:10px}
.modal input,.modal select,.modal textarea{width:100%;padding:8px 11px;background:var(--bg-dark);border:1px solid var(--border);border-radius:8px;color:var(--text);font-family:inherit;font-size:0.86rem;outline:none}
.modal textarea{resize:vertical;min-height:60px}
.modal input:focus,.modal textarea:focus{border-color:var(--purple)}
.emoji-picker{display:flex;gap:5px;flex-wrap:wrap;margin-top:5px}
.ep{width:32px;height:32px;border-radius:7px;border:1px solid var(--border);background:var(--bg-dark);font-size:1rem;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all 0.2s}
.ep:hover,.ep.sel{border-color:var(--purple);background:rgba(108,92,231,0.15)}
.macts{display:flex;gap:8px;margin-top:18px;justify-content:flex-end}
.macts button{padding:8px 16px;border-radius:8px;font-family:inherit;font-weight:600;font-size:0.83rem;cursor:pointer;transition:all 0.2s}
.bx{background:none;border:1px solid var(--border);color:var(--text-dim)}
.bx:hover{border-color:var(--text-dim);color:var(--text)}
.bok{background:var(--purple);border:none;color:white}
.bok:hover{background:var(--purple-dark)}
.bdel{background:var(--red);border:none;color:white}

/* Inbox row */
.inb{display:flex;align-items:center;gap:8px;padding:9px;border:1px solid var(--border);border-radius:10px;margin-bottom:7px;background:rgba(255,255,255,0.02)}
.inb .info{flex:1;min-width:0}
.inb .info .lbl{font-size:0.86rem;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.inb .info .url{font-family:'JetBrains Mono',monospace;font-size:0.63rem;color:var(--text-dim);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.inb select{width:130px;padding:5px 7px;background:var(--bg-dark);border:1px solid var(--border);border-radius:6px;color:var(--text);font-size:0.78rem;flex-shrink:0}
.inb button{padding:5px 10px;border:none;border-radius:6px;font-size:0.78rem;cursor:pointer;flex-shrink:0;font-weight:600}
.inb .classify{background:var(--green);color:white}
.inb .trash{background:var(--red);color:white}

/* Toast */
.toast{position:fixed;bottom:20px;left:50%;transform:translateX(-50%) translateY(80px);background:var(--bg-card);border:1px solid var(--green);color:var(--text);padding:10px 18px;border-radius:10px;font-size:0.85rem;z-index:300;opacity:0;transition:all 0.3s}
.toast.show{transform:translateX(-50%) translateY(0);opacity:1}
.toast.err{border-color:var(--red)}

@media(max-width:700px){.app-grid{grid-template-columns:1fr}.sidebar{display:none}.content{padding:14px}.itm .vl,.itm .nt{display:none}.chat-panel{width:calc(100vw - 20px);right:10px;bottom:70px}}
</style>
</head>
<body>

<div id="loginScreen">
  <div class="login-box">
    <h1>üî® DayForge</h1>
    <p class="sub">Forja tu d√≠a la noche anterior</p>
    <input type="text" id="loginUser" placeholder="Usuario">
    <input type="password" id="loginPass" placeholder="Contrase√±a">
    <button onclick="doLogin()">Entrar</button>
    <div class="login-error" id="loginError"></div>
  </div>
</div>

<div id="appScreen">
  <div class="header">
    <div class="header-left"><span class="header-logo">üî® DayForge</span></div>
    <div class="header-right">
      <button class="hdr-btn" onclick="showInbox()" id="inboxBtn">üì• Inbox <span class="badge" id="inboxBadge" style="display:none">0</span></button>
      <button class="hdr-btn" onclick="showBm()">üìé</button>
      <div class="dev-st"><div class="dev-dot" id="agentDot"></div><span id="agentLbl">...</span></div>
      <button class="hdr-btn" onclick="loadAll()">‚Üª</button>
      <button class="hdr-btn" onclick="doLogout()">Salir</button>
    </div>
  </div>

  <div class="app-grid">
    <div class="sidebar" id="sidebar">
      <div class="sb-sec"><div class="sb-title">Workspaces</div><div id="sbWs"></div><div class="sb-add" onclick="openNewWs()">+ Nuevo workspace</div></div>
      <div class="sb-sec" id="pinSec" style="display:none"><div class="sb-title">üìå Permanentes</div><div id="sbPins"></div><div class="sb-add" onclick="addPerm()">+ Enlace permanente</div></div>
      <div class="sb-sec" id="appSec" style="display:none"><div class="sb-title">üöÄ Apps</div><div id="sbApps"></div>
        <div class="sb-row"><input type="text" id="newApp" placeholder="Ruta .exe" onkeydown="if(event.key==='Enter')addApp()"><button onclick="addApp()">+</button></div>
        <button class="sb-launch" id="launchBtn" onclick="launchApps()" disabled>üöÄ Lanzar seleccionadas</button>
      </div>
    </div>

    <div class="content" id="content">
      <div class="hyp-panel"><div class="hyp-av">üíú</div><div class="body"><div class="lab">Hypatia observa</div><div class="msg" id="hypMsg">Cargando...</div></div><button class="rf" onclick="loadHyp()">‚Üª</button></div>
      <div id="wsContent"><div class="empty"><div class="ic">üî®</div><p>Selecciona un workspace o crea uno nuevo.<br>Prepara tu d√≠a por la noche. L√°nzalo por la ma√±ana.</p></div></div>
    </div>
  </div>

  <!-- Hypatia Chat -->
  <button class="chat-toggle" id="chatToggle" onclick="toggleChat()">üíú</button>
  <div class="chat-panel" id="chatPanel">
    <div class="chat-hdr">
      <div class="av">üíú</div>
      <span class="title">Hypatia</span>
      <select id="chatWs" onchange="loadChatHistory()"></select>
      <button class="close" onclick="toggleChat()">‚úï</button>
    </div>
    <div class="chat-body" id="chatBody"></div>
    <div class="chat-typing" id="chatTyping">Hypatia est√° pensando...</div>
    <div class="chat-input-row">
      <input type="text" id="chatInput" placeholder="H√°blame del proyecto..." onkeydown="if(event.key==='Enter')sendChat()">
      <button onclick="sendChat()">‚Üí</button>
    </div>
  </div>
</div>

<!-- Modal: Workspace -->
<div class="mbg" id="wsModal"><div class="modal">
  <h2 id="wsModalTitle">Nuevo Workspace</h2>
  <label>Nombre</label><input type="text" id="wsName" maxlength="40">
  <label>Icono</label><div class="emoji-picker" id="emojiP"></div>
  <input type="text" id="wsIconC" placeholder="Emoji" maxlength="2" style="margin-top:5px;width:60px">
  <div class="macts"><button class="bx" onclick="closeM('wsModal')">Cancelar</button><button class="bdel" id="wsDelBtn" style="display:none" onclick="deleteWs()">Eliminar</button><button class="bok" onclick="saveWs()">Guardar</button></div>
</div></div>

<!-- Modal: Edit Item -->
<div class="mbg" id="editModal"><div class="modal">
  <h2>Editar Item</h2>
  <label>Tipo</label><select id="eType"><option value="url">üåê URL</option><option value="app">üì± App</option><option value="file">üìÑ Archivo</option><option value="note">üìù Nota</option></select>
  <label>Valor</label><input type="text" id="eValue">
  <label>Etiqueta</label><input type="text" id="eLabel">
  <label>Categor√≠a</label><select id="eCat"></select>
  <label>Notas / Anotaciones</label><textarea id="eNotes" placeholder="Apuntes sobre este enlace..."></textarea>
  <label>Mover a workspace</label><select id="eWs"></select>
  <label style="margin-top:12px"><input type="checkbox" id="ePin" style="width:auto;margin-right:6px"> üìå Enlace permanente</label>
  <div class="macts"><button class="bx" onclick="closeM('editModal')">Cancelar</button><button class="bok" onclick="saveEdit()">Guardar</button></div>
</div></div>

<!-- Modal: Category -->
<div class="mbg" id="catModal"><div class="modal">
  <h2 id="catModalTitle">Nueva Categor√≠a</h2>
  <label>Nombre</label><input type="text" id="catName" maxlength="40">
  <label>Descripci√≥n</label><textarea id="catDesc" placeholder="¬øPara qu√© es esta categor√≠a?"></textarea>
  <div class="macts"><button class="bx" onclick="closeM('catModal')">Cancelar</button><button class="bdel" id="catDelBtn" style="display:none" onclick="deleteCat()">Eliminar</button><button class="bok" onclick="saveCat()">Guardar</button></div>
</div></div>

<!-- Modal: Inbox -->
<div class="mbg" id="inboxModal"><div class="modal" style="width:520px">
  <h2>üì• Clasificar Inbox</h2>
  <p style="color:var(--text-dim);font-size:0.83rem;margin-bottom:12px">Asigna cada item a un workspace o elim√≠nalo.</p>
  <div id="inboxItems"></div>
  <div id="inboxEmpty" style="display:none;text-align:center;padding:20px;color:var(--text-dim)"><div style="font-size:2rem;margin-bottom:8px">‚úÖ</div>Inbox vac√≠o</div>
  <div class="macts"><button class="bok" onclick="closeM('inboxModal')">Cerrar</button></div>
</div></div>

<!-- Modal: Bookmarklet -->
<div class="mbg" id="bmModal"><div class="modal">
  <h2>üìé Capturar Tabs</h2>
  <p style="color:var(--text-dim);font-size:0.86rem;margin-bottom:14px;line-height:1.5">Arrastra este bot√≥n a tu <strong>barra de marcadores</strong>.</p>
  <div style="text-align:center;margin:16px 0"><a id="bmLink" href="#" style="display:inline-block;padding:10px 20px;background:linear-gradient(135deg,var(--purple),var(--orange));color:white;border-radius:8px;text-decoration:none;font-weight:600;cursor:grab" onclick="event.preventDefault();showToast('Arr√°strame a la barra')">üìé + DayForge</a></div>
  <div class="macts"><button class="bok" onclick="closeM('bmModal')">OK</button></div>
</div></div>

<div class="toast" id="toast"></div>

<script>
// ‚ïê‚ïê‚ïê DayForge v3.0 ‚ïê‚ïê‚ïê
const API='';
let TOKEN=localStorage.getItem('dayforge_token')||'';
let workspaces=[],categories=[],currentWsId=null,currentItems=[],curFilter='';
let editingWsId=null,editingItemId=null,editingCatId=null,selectedEmoji='üìÅ',selApps=new Set();
let chatOpen=false;
const AGENT='http://localhost:5555';
const EMOJIS=['üìÅ','üé®','üî¨','üìù','üíº','üöÄ','üéØ','üìä','üéµ','üìö','üîß','üí°','üåê','üé¨','üì±','üè†','‚ú®','üß†','üìÇ','üéì'];
const TI={url:'üåê',app:'üì±',file:'üìÑ',note:'üìù'};
const INBOX='üì• Inbox';

// ‚îÄ‚îÄ‚îÄ Auth ‚îÄ‚îÄ‚îÄ
async function doLogin(){const u=$('loginUser').value,p=$('loginPass').value;try{const r=await fetch(`${API}/api/auth/login`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({username:u,password:p})});if(!r.ok){$('loginError').textContent='Credenciales incorrectas';return;}const d=await r.json();TOKEN=d.token;localStorage.setItem('dayforge_token',TOKEN);showApp();}catch(e){$('loginError').textContent='Error de conexi√≥n';}}
function doLogout(){TOKEN='';localStorage.removeItem('dayforge_token');$('appScreen').style.display='none';$('loginScreen').style.display='flex';}
async function checkAuth(){if(!TOKEN)return false;try{return(await api('/api/auth/verify')).valid;}catch{return false;}}

// ‚îÄ‚îÄ‚îÄ API ‚îÄ‚îÄ‚îÄ
async function api(path,opts={}){const r=await fetch(`${API}${path}`,{...opts,headers:{'Content-Type':'application/json','Authorization':`Bearer ${TOKEN}`,...(opts.headers||{})}});if(r.status===401){doLogout();throw Error('Unauth');}if(!r.ok)throw Error(`API ${r.status}`);return r.json();}

// ‚îÄ‚îÄ‚îÄ Init ‚îÄ‚îÄ‚îÄ
async function showApp(){$('loginScreen').style.display='none';$('appScreen').style.display='block';await loadAll();}
async function loadAll(){await loadWsList();checkAgent();loadHyp();updateBadge();updateChatWsSelect();}

// ‚îÄ‚îÄ‚îÄ Agent ‚îÄ‚îÄ‚îÄ
async function checkAgent(){try{const r=await fetch(`${AGENT}/health`,{signal:AbortSignal.timeout(2000)});if(r.ok){const d=await r.json();$('agentDot').className='dev-dot';$('agentLbl').textContent=d.name||'OK';}else throw 0;}catch{$('agentDot').className='dev-dot off';$('agentLbl').textContent='Sin agente';}}

// ‚îÄ‚îÄ‚îÄ Workspaces ‚îÄ‚îÄ‚îÄ
async function loadWsList(){const d=await api('/api/workspaces');workspaces=d.workspaces||[];renderSb();if(currentWsId&&workspaces.find(w=>w.id===currentWsId))await selWs(currentWsId);updateBadge();}
function renderSb(){$('sbWs').innerHTML=workspaces.filter(w=>w.status!=='archived'&&w.name!==INBOX).map(w=>`<div class="sb-ws ${w.id===currentWsId?'active':''}" onclick="selWs('${w.id}')"><span class="icon">${w.icon||'üìÅ'}</span><span class="name">${esc(w.name)}</span><span class="cnt">${w.pending_count||0}</span>${w.status==='forged'?'<span class="fire">üî•</span>':''}</div>`).join('');}
async function selWs(id){currentWsId=id;curFilter='';selApps.clear();renderSb();await loadCats(id);await loadContent(id);}

// ‚îÄ‚îÄ‚îÄ Categories ‚îÄ‚îÄ‚îÄ
async function loadCats(wid){const d=await api(`/api/categories/${wid}`);categories=d.categories||[];}
function renderCatBar(){
  if(categories.length===0)return `<div class="cat-bar"><button class="cat-pill on" onclick="filterCat('')">Todo</button><button class="cat-pill" onclick="openNewCat()">+ Categor√≠a</button></div>`;
  return `<div class="cat-bar"><button class="cat-pill ${curFilter===''?'on':''}" onclick="filterCat('')">Todo</button>${categories.map(c=>`<button class="cat-pill ${curFilter===c.id?'on':''}" onclick="filterCat('${c.id}')" ondblclick="openEditCat('${c.id}')" title="${esc(c.description||'Doble click para editar')}">${esc(c.name)}<span class="cnt">${c.item_count||0}</span></button>`).join('')}<button class="cat-pill" onclick="openNewCat()">+</button></div>`;
}
function filterCat(cid){curFilter=cid;loadContent(currentWsId);}

// Category modal
function openNewCat(){editingCatId=null;$('catModalTitle').textContent='Nueva Categor√≠a';$('catName').value='';$('catDesc').value='';$('catDelBtn').style.display='none';openM('catModal');}
function openEditCat(id){const c=categories.find(x=>x.id===id);if(!c)return;editingCatId=id;$('catModalTitle').textContent='Editar Categor√≠a';$('catName').value=c.name;$('catDesc').value=c.description||'';$('catDelBtn').style.display='inline-block';openM('catModal');}
async function saveCat(){const name=$('catName').value.trim(),desc=$('catDesc').value.trim();if(!name){showToast('Nombre requerido',1);return;}if(editingCatId){await api(`/api/categories/${editingCatId}`,{method:'PUT',body:JSON.stringify({name,description:desc})});}else{await api('/api/categories',{method:'POST',body:JSON.stringify({workspace_id:currentWsId,name,description:desc,order:categories.length})});}closeM('catModal');await loadCats(currentWsId);await loadContent(currentWsId);showToast(editingCatId?'Categor√≠a actualizada':'Categor√≠a creada');}
async function deleteCat(){if(!editingCatId||!confirm('¬øEliminar categor√≠a? Los items se quedar√°n sin categor√≠a.'))return;await api(`/api/categories/${editingCatId}`,{method:'DELETE'});closeM('catModal');curFilter='';await loadCats(currentWsId);await loadContent(currentWsId);showToast('Categor√≠a eliminada');}

// ‚îÄ‚îÄ‚îÄ Content ‚îÄ‚îÄ‚îÄ
async function loadContent(id){
  const ws=workspaces.find(w=>w.id===id);if(!ws)return;
  let url=`/api/items/${id}`;if(curFilter)url+=`?category=${curFilter}`;
  const d=await api(url);currentItems=d.items||[];
  // Also load all items for sidebar counts
  const allD=curFilter?await api(`/api/items/${id}`):d;const allItems=allD.items||[];

  const perms=allItems.filter(i=>i.permanent);
  const pinLinks=perms.filter(i=>i.type!=='app');
  const apps=perms.filter(i=>i.type==='app');
  const work=currentItems.filter(i=>!i.permanent);
  const pending=work.filter(i=>i.status==='pending');
  const done=work.filter(i=>i.status==='done');

  // Sidebar: pins
  $('pinSec').style.display='block';
  $('sbPins').innerHTML=pinLinks.length===0?'<div style="font-size:0.76rem;color:var(--text-dim);padding:4px 10px">Sin enlaces fijos</div>':pinLinks.map(p=>`<div class="sb-pin"><span style="font-size:0.8rem">${TI[p.type]||'üìÑ'}</span><a href="${esc(p.value)}" target="_blank" class="lbl">${esc(p.label)}</a><div class="acts"><button class="pbtn" onclick="editItem('${p.id}')">‚úèÔ∏è</button><button class="pbtn" onclick="unpin('${p.id}')">üìã</button></div></div>`).join('');

  // Sidebar: apps
  $('appSec').style.display='block';
  $('sbApps').innerHTML=apps.length===0?'<div style="font-size:0.76rem;color:var(--text-dim);padding:4px 10px">Sin apps</div>':apps.map(a=>`<div class="sb-app" onclick="toggleAppSel('${a.id}')"><div class="achk ${selApps.has(a.id)?'on':''}">‚úì</div><span class="nm">${esc(a.label)}</span><button class="dl" onclick="event.stopPropagation();delItem('${a.id}')">‚úï</button></div>`).join('');
  $('launchBtn').disabled=selApps.size===0;

  const forged=ws.status==='forged';
  const catMap={};categories.forEach(c=>catMap[c.id]=c.name);

  $('wsContent').innerHTML=`
    <div class="ws-hdr"><div class="ws-hdr-left"><span class="ic">${ws.icon||'üìÅ'}</span><h2>${esc(ws.name)}</h2></div>
    <div class="ws-hdr-right"><button class="wb ${forged?'fon':''}" onclick="toggleForge('${ws.id}',${forged})">${forged?'üî• Forjado':'üî• Marcar hoy'}</button><button class="wb" onclick="openEditWs('${ws.id}')">‚úèÔ∏è</button><button class="wb" onclick="clearDone()">Limpiar ‚úì</button></div></div>
    ${renderCatBar()}
    <div class="itm-label">üìã Items (${pending.length} pendientes${curFilter?' ‚Äî filtro activo':''})</div>
    ${pending.length===0&&done.length===0?'<div style="padding:14px;color:var(--text-dim);font-size:0.86rem">Sin items. A√±ade URLs, notas o archivos.</div>':''}
    ${[...pending,...done].map(i=>{
      const catName=catMap[i.category||'']||'';
      const notePrev=i.notes?(i.notes.length>30?i.notes.substring(0,30)+'...':i.notes):'';
      return `<div class="itm ${i.status==='done'?'done':''}" data-id="${i.id}">
      <div class="ichk ${i.status==='done'?'on':''}" onclick="toggleSt('${i.id}','${i.status}')">‚úì</div>
      <span class="tp">${TI[i.type]||'üìÑ'}</span>
      <span class="lb" onclick="editItem('${i.id}')">${esc(i.label)}</span>
      ${catName?`<span style="font-size:0.62rem;color:var(--purple-light);background:rgba(108,92,231,0.1);padding:1px 6px;border-radius:4px">${esc(catName)}</span>`:''}
      ${notePrev?`<span class="nt" title="${esc(i.notes||'')}">üìù ${esc(notePrev)}</span>`:''}
      <span class="vl">${esc(trn(i.value,30))}</span>
      <div class="iacts"><button class="ib" onclick="pin('${i.id}')" title="Fijar">üìå</button><button class="ib" onclick="editItem('${i.id}')" title="Editar">‚úèÔ∏è</button><button class="ib del" onclick="delItem('${i.id}')" title="Eliminar">‚úï</button></div>
    </div>`;}).join('')}
    <div class="add-row">
      <select id="nType"><option value="url">üåê</option><option value="note">üìù</option><option value="file">üìÑ</option></select>
      <input type="text" id="nValue" placeholder="URL, nota o ruta..." onkeydown="if(event.key==='Enter')addItem()">
      <input type="text" id="nLabel" placeholder="Etiqueta" style="width:110px" onkeydown="if(event.key==='Enter')addItem()">
      ${categories.length>0?`<select id="nCat"><option value="">Sin cat.</option>${categories.map(c=>`<option value="${c.id}" ${c.id===curFilter?'selected':''}>${esc(c.name)}</option>`).join('')}</select>`:''}
      <button onclick="addItem()">+</button>
    </div>
    ${forged?`<div class="forge-sec"><button class="forge-btn" onclick="forgeDay()">üöÄ FORJAR D√çA</button><div class="forge-cnt">${pending.length} items + ${apps.length} apps</div></div>`:''}`;
}

// ‚îÄ‚îÄ‚îÄ Items ‚îÄ‚îÄ‚îÄ
async function addItem(){const t=$('nType').value,v=$('nValue').value.trim(),l=$('nLabel').value.trim(),catEl=$('nCat'),cat=catEl?catEl.value:'';if(!v)return;await api('/api/items',{method:'POST',body:JSON.stringify({workspace_id:currentWsId,type:t,value:v,label:l,permanent:false,category:cat,order:999})});$('nValue').value='';$('nLabel').value='';await loadContent(currentWsId);await loadWsList();}
async function toggleSt(id,st){await api(`/api/items/${id}`,{method:'PUT',body:JSON.stringify({status:st==='pending'?'done':'pending'})});await loadContent(currentWsId);await loadWsList();}
async function delItem(id){await api(`/api/items/${id}`,{method:'DELETE'});await loadContent(currentWsId);await loadWsList();}
async function pin(id){await api(`/api/items/${id}`,{method:'PUT',body:JSON.stringify({permanent:true})});await loadContent(currentWsId);showToast('üìå Fijado');}
async function unpin(id){await api(`/api/items/${id}`,{method:'PUT',body:JSON.stringify({permanent:false})});await loadContent(currentWsId);showToast('üìã A trabajo');}
async function clearDone(){if(!currentWsId)return;await api(`/api/items/${currentWsId}/clear-done`,{method:'POST'});await loadContent(currentWsId);await loadWsList();showToast('Limpiado');}
async function addPerm(){const v=prompt('URL o ruta:');if(!v)return;const l=prompt('Etiqueta:',v.replace('https://','').split('/')[0])||v;await api('/api/items',{method:'POST',body:JSON.stringify({workspace_id:currentWsId,type:'url',value:v,label:l,permanent:true,order:0})});await loadContent(currentWsId);}

// ‚îÄ‚îÄ‚îÄ Apps ‚îÄ‚îÄ‚îÄ
function toggleAppSel(id){if(selApps.has(id))selApps.delete(id);else selApps.add(id);loadContent(currentWsId);}
async function addApp(){const p=$('newApp').value.trim();if(!p)return;const l=p.split('\\').pop().split('/').pop().replace('.exe','');await api('/api/items',{method:'POST',body:JSON.stringify({workspace_id:currentWsId,type:'app',value:p,label:l,permanent:true,order:0})});$('newApp').value='';await loadContent(currentWsId);}
async function launchApps(){const apps=currentItems.filter(i=>selApps.has(i.id));let ok=0,agOk=false;try{const r=await fetch(`${AGENT}/health`,{signal:AbortSignal.timeout(2000)});agOk=r.ok;}catch{}if(!agOk){showToast('Sin agente',1);return;}for(const a of apps){try{await fetch(`${AGENT}/launch`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({type:'app',path:a.value})});ok++;}catch{}}showToast(`üöÄ ${ok} app${ok>1?'s':''} lanzada${ok>1?'s':''}`);selApps.clear();loadContent(currentWsId);}

// ‚îÄ‚îÄ‚îÄ Forge ‚îÄ‚îÄ‚îÄ
async function forgeDay(){const d=await api('/api/sessions/forge',{method:'POST'});const items=d.items_to_launch||[];if(!items.length){showToast('Nada pendiente',1);return;}let ok=0,agOk=false;try{const r=await fetch(`${AGENT}/health`,{signal:AbortSignal.timeout(2000)});agOk=r.ok;}catch{}const urls=items.filter(i=>i.type==='url'&&!i.permanent),apps=items.filter(i=>i.type==='app');if(urls.length>0){window.open(urls[0].value,'_blank');ok++;}for(let i=1;i<urls.length;i++){await sleep(400);window.open(urls[i].value,'_blank');ok++;}if(agOk){for(const a of apps){try{await fetch(`${AGENT}/launch`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({type:'app',path:a.value})});ok++;}catch{}}}showToast(`üöÄ ${ok} items lanzados`);setTimeout(()=>loadHyp(),2000);}
async function toggleForge(id,on){await api(`/api/workspaces/${id}`,{method:'PUT',body:JSON.stringify({status:on?'active':'forged'})});await loadWsList();await loadContent(id);}

// ‚îÄ‚îÄ‚îÄ Edit Item ‚îÄ‚îÄ‚îÄ
async function editItem(id){const i=currentItems.find(x=>x.id===id);if(!i)return;editingItemId=id;$('eType').value=i.type;$('eValue').value=i.value;$('eLabel').value=i.label;$('eNotes').value=i.notes||'';$('ePin').checked=i.permanent||false;$('eCat').innerHTML=`<option value="">Sin categor√≠a</option>${categories.map(c=>`<option value="${c.id}" ${c.id===(i.category||'')?'selected':''}>${esc(c.name)}</option>`).join('')}`;$('eWs').innerHTML=workspaces.filter(w=>w.status!=='archived').map(w=>`<option value="${w.id}" ${w.id===currentWsId?'selected':''}>${w.icon} ${esc(w.name)}</option>`).join('');openM('editModal');}
async function saveEdit(){if(!editingItemId)return;const u={type:$('eType').value,value:$('eValue').value.trim(),label:$('eLabel').value.trim(),notes:$('eNotes').value.trim(),category:$('eCat').value,permanent:$('ePin').checked};if(!u.value){showToast('Valor vac√≠o',1);return;}if(!u.label)u.label=u.value.substring(0,50);const nws=$('eWs').value;if(nws!==currentWsId)u.workspace_id=nws;await api(`/api/items/${editingItemId}`,{method:'PUT',body:JSON.stringify(u)});closeM('editModal');editingItemId=null;await loadCats(currentWsId);await loadContent(currentWsId);await loadWsList();showToast('Actualizado');}

// ‚îÄ‚îÄ‚îÄ Inbox ‚îÄ‚îÄ‚îÄ
async function updateBadge(){const ib=workspaces.find(w=>w.name===INBOX);if(ib&&ib.pending_count>0){$('inboxBadge').textContent=ib.pending_count;$('inboxBadge').style.display='flex';}else $('inboxBadge').style.display='none';}
async function showInbox(){const ib=workspaces.find(w=>w.name===INBOX);if(!ib){$('inboxItems').innerHTML='';$('inboxEmpty').style.display='block';openM('inboxModal');return;}const d=await api(`/api/items/${ib.id}`);const items=(d.items||[]).filter(i=>i.status==='pending');if(!items.length){$('inboxItems').innerHTML='';$('inboxEmpty').style.display='block';}else{$('inboxEmpty').style.display='none';const opts=workspaces.filter(w=>w.status!=='archived'&&w.name!==INBOX).map(w=>`<option value="${w.id}">${w.icon} ${esc(w.name)}</option>`).join('');$('inboxItems').innerHTML=items.map(i=>`<div class="inb" id="ib-${i.id}"><div class="info"><div class="lbl">${esc(i.label)}</div><div class="url">${esc(trn(i.value,50))}</div></div><select id="ibs-${i.id}">${opts}<option value="_new">+ Nuevo</option></select><button class="classify" onclick="classify('${i.id}')">‚Üí</button><button class="trash" onclick="delInbox('${i.id}')">‚úï</button></div>`).join('');}openM('inboxModal');}
async function classify(id){const ws=$(`ibs-${id}`).value;if(ws==='_new'){const name=prompt('Nombre del nuevo workspace:');if(!name)return;const d=await api('/api/workspaces',{method:'POST',body:JSON.stringify({name,icon:'üìÅ',status:'active',order:workspaces.length})});await api(`/api/items/${id}`,{method:'PUT',body:JSON.stringify({workspace_id:d.workspace.id})});}else{await api(`/api/items/${id}`,{method:'PUT',body:JSON.stringify({workspace_id:ws})});}$(`ib-${id}`)?.remove();await loadWsList();updateBadge();if(!$('inboxItems').children.length)$('inboxEmpty').style.display='block';showToast('‚úÖ Clasificado');}
async function delInbox(id){await api(`/api/items/${id}`,{method:'DELETE'});$(`ib-${id}`)?.remove();await loadWsList();updateBadge();if(!$('inboxItems').children.length)$('inboxEmpty').style.display='block';showToast('Eliminado del inbox');}

// ‚îÄ‚îÄ‚îÄ Workspace Modal ‚îÄ‚îÄ‚îÄ
function openNewWs(){editingWsId=null;$('wsModalTitle').textContent='Nuevo Workspace';$('wsName').value='';$('wsIconC').value='';$('wsDelBtn').style.display='none';selectedEmoji='üìÅ';renderEmoji();openM('wsModal');}
function openEditWs(id){const w=workspaces.find(x=>x.id===id);if(!w)return;editingWsId=id;$('wsModalTitle').textContent='Editar';$('wsName').value=w.name;$('wsIconC').value='';$('wsDelBtn').style.display='inline-block';selectedEmoji=w.icon||'üìÅ';renderEmoji();openM('wsModal');}
function renderEmoji(){$('emojiP').innerHTML=EMOJIS.map(e=>`<div class="ep ${e===selectedEmoji?'sel':''}" onclick="pickE('${e}')">${e}</div>`).join('');}
function pickE(e){selectedEmoji=e;$('wsIconC').value='';renderEmoji();}
async function saveWs(){const name=$('wsName').value.trim(),icon=$('wsIconC').value.trim()||selectedEmoji;if(!name){showToast('Nombre',1);return;}if(editingWsId){await api(`/api/workspaces/${editingWsId}`,{method:'PUT',body:JSON.stringify({name,icon})});}else{const d=await api('/api/workspaces',{method:'POST',body:JSON.stringify({name,icon,status:'active',order:workspaces.length})});currentWsId=d.workspace.id;}closeM('wsModal');await loadWsList();if(currentWsId)await selWs(currentWsId);showToast(editingWsId?'Actualizado':'Creado');}
async function deleteWs(){if(!editingWsId||!confirm('¬øEliminar workspace y todo su contenido?'))return;await api(`/api/workspaces/${editingWsId}`,{method:'DELETE'});closeM('wsModal');if(currentWsId===editingWsId){currentWsId=null;$('wsContent').innerHTML='<div class="empty"><div class="ic">üî®</div><p>Selecciona un workspace</p></div>';$('pinSec').style.display='none';$('appSec').style.display='none';}await loadWsList();showToast('Eliminado');}

// ‚îÄ‚îÄ‚îÄ Hypatia Observe ‚îÄ‚îÄ‚îÄ
async function loadHyp(){try{const h=new Date().getHours(),ctx=h<14?'morning':h<21?'evening':'night';const d=await api('/api/hypatia/observe',{method:'POST',body:JSON.stringify({context:ctx})});$('hypMsg').textContent=d.message||'üíú';}catch{$('hypMsg').textContent='Conectando... üíú';}}

// ‚îÄ‚îÄ‚îÄ Hypatia Chat ‚îÄ‚îÄ‚îÄ
function toggleChat(){chatOpen=!chatOpen;$('chatPanel').className=chatOpen?'chat-panel open':'chat-panel';if(chatOpen){updateChatWsSelect();if(currentWsId)$('chatWs').value=currentWsId;loadChatHistory();$('chatInput').focus();}}
function updateChatWsSelect(){$('chatWs').innerHTML=`<option value="general">üí¨ General</option>${workspaces.filter(w=>w.status!=='archived'&&w.name!==INBOX).map(w=>`<option value="${w.id}" ${w.id===currentWsId?'selected':''}>${w.icon} ${esc(w.name)}</option>`).join('')}`;}
async function loadChatHistory(){const wid=$('chatWs').value||'general';try{const d=await api(`/api/hypatia/chat-history/${wid}`);const hist=d.history||[];renderChat(hist);}catch{renderChat([]);}}
function renderChat(hist){const body=$('chatBody');body.innerHTML=hist.length===0?'<div style="text-align:center;padding:30px;color:var(--text-dim);font-size:0.85rem">üíú H√°blame sobre este proyecto...</div>':hist.map(h=>`<div class="chat-msg user"><div class="who">Carles</div><div class="bubble">${esc(h.user)}</div></div><div class="chat-msg hyp"><div class="who">Hypatia</div><div class="bubble">${esc(h.hypatia)}</div></div>`).join('');body.scrollTop=body.scrollHeight;}
async function sendChat(){const input=$('chatInput'),msg=input.value.trim();if(!msg)return;const wid=$('chatWs').value||'general';input.value='';const body=$('chatBody');body.innerHTML+=`<div class="chat-msg user"><div class="who">Carles</div><div class="bubble">${esc(msg)}</div></div>`;body.scrollTop=body.scrollHeight;$('chatTyping').style.display='block';try{const d=await api('/api/hypatia/chat',{method:'POST',body:JSON.stringify({workspace_id:wid,message:msg})});$('chatTyping').style.display='none';body.innerHTML+=`<div class="chat-msg hyp"><div class="who">Hypatia</div><div class="bubble">${esc(d.reply)}</div></div>`;body.scrollTop=body.scrollHeight;}catch(e){$('chatTyping').style.display='none';body.innerHTML+=`<div class="chat-msg hyp"><div class="who">Hypatia</div><div class="bubble">Error de conexi√≥n üíú</div></div>`;}}

// ‚îÄ‚îÄ‚îÄ Bookmarklet ‚îÄ‚îÄ‚îÄ
function showBm(){const u=window.location.origin,t=TOKEN;$('bmLink').href="javascript:void(function(){var t='"+t+"';fetch('"+u+"/api/quick-add',{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+t},body:JSON.stringify({workspace_id:'inbox',type:'url',value:location.href,label:document.title.substring(0,60)})}).then(function(r){return r.json()}).then(function(d){if(d.item){var n=document.createElement('div');n.textContent='\\u2705 DayForge: '+d.item.label;n.style.cssText='position:fixed;top:12px;right:12px;background:%231a1a2e;color:%23e8e8f0;padding:12px 20px;border:1px solid %236C5CE7;border-radius:10px;z-index:99999;font:14px sans-serif';document.body.appendChild(n);setTimeout(function(){n.remove()},2500)}}).catch(function(e){alert('DayForge: '+e)})})()";openM('bmModal');}

// ‚îÄ‚îÄ‚îÄ Utils ‚îÄ‚îÄ‚îÄ
function $(id){return document.getElementById(id)}
function openM(id){$(id).classList.add('on')}
function closeM(id){$(id).classList.remove('on')}
function showToast(msg,err){const t=$('toast');t.textContent=msg;t.className=`toast show ${err?'err':''}`;setTimeout(()=>t.className='toast',3000);}
function esc(s){const d=document.createElement('div');d.textContent=s||'';return d.innerHTML}
function trn(s,n){return(s||'').length>n?s.substring(0,n)+'...':s||''}
function sleep(ms){return new Promise(r=>setTimeout(r,ms))}
$('loginPass').addEventListener('keydown',e=>{if(e.key==='Enter')doLogin();});
(async()=>{if(await checkAuth())showApp();else $('loginScreen').style.display='flex';})();
</script>
</body>
</html>
