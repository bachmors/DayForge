<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DayForge ‚Äî Forja tu D√≠a</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700;800;900&family=IBM+Plex+Sans:wght@300;400;500;600&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
:root {
  --purple: #6C5CE7;
  --purple-light: #a855f7;
  --purple-dark: #4a3aa0;
  --orange: #FD7014;
  --green: #00B894;
  --red: #e74c3c;
  --bg-dark: #0a0a1a;
  --bg-card: #12122a;
  --bg-sidebar: #0e0e22;
  --border: rgba(108, 92, 231, 0.2);
  --text: #e8e8f0;
  --text-dim: #8888aa;
  --text-bright: #ffffff;
  --hypatia-bg: rgba(168, 85, 247, 0.08);
  --hypatia-border: rgba(168, 85, 247, 0.25);
}
* { margin:0; padding:0; box-sizing:border-box; }
body { font-family:'IBM Plex Sans',sans-serif; background:var(--bg-dark); color:var(--text); min-height:100vh; }
body::before {
  content:''; position:fixed; top:-50%; left:-50%; width:200%; height:200%;
  background: radial-gradient(ellipse at 20% 20%, rgba(108,92,231,0.06) 0%, transparent 50%),
              radial-gradient(ellipse at 80% 80%, rgba(253,112,20,0.04) 0%, transparent 50%);
  pointer-events:none; z-index:0;
}

/* LOGIN */
#loginScreen { display:flex; flex-direction:column; align-items:center; justify-content:center; height:100vh; position:relative; z-index:1; }
.login-box { background:var(--bg-card); border:1px solid var(--border); border-radius:20px; padding:48px 40px; width:380px; text-align:center; }
.login-box h1 { font-family:'Playfair Display',serif; font-weight:800; font-size:2.4rem; background:linear-gradient(135deg,var(--purple-light),var(--orange)); -webkit-background-clip:text; -webkit-text-fill-color:transparent; margin-bottom:8px; }
.login-box .sub { color:var(--text-dim); font-size:0.9rem; margin-bottom:32px; font-weight:300; }
.login-box input { width:100%; padding:12px 16px; background:var(--bg-dark); border:1px solid var(--border); border-radius:10px; color:var(--text); font-family:'IBM Plex Sans',sans-serif; font-size:0.95rem; margin-bottom:12px; outline:none; }
.login-box input:focus { border-color:var(--purple); }
.login-box button { width:100%; padding:12px; background:linear-gradient(135deg,var(--purple),var(--purple-dark)); color:white; border:none; border-radius:10px; font-family:'IBM Plex Sans',sans-serif; font-weight:600; font-size:1rem; cursor:pointer; margin-top:8px; }
.login-error { color:var(--red); font-size:0.85rem; margin-top:12px; min-height:20px; }

/* APP LAYOUT */
#appScreen { display:none; position:relative; z-index:1; height:100vh; }
.header { display:flex; align-items:center; justify-content:space-between; padding:10px 20px; border-bottom:1px solid var(--border); background:rgba(10,10,26,0.9); backdrop-filter:blur(12px); position:sticky; top:0; z-index:100; height:50px; }
.header-left { display:flex; align-items:center; gap:12px; }
.header-logo { font-family:'Playfair Display',serif; font-weight:800; font-size:1.3rem; background:linear-gradient(135deg,var(--purple-light),var(--orange)); -webkit-background-clip:text; -webkit-text-fill-color:transparent; }
.header-right { display:flex; align-items:center; gap:10px; }
.device-status { display:flex; align-items:center; gap:6px; font-size:0.75rem; color:var(--text-dim); font-family:'JetBrains Mono',monospace; }
.device-dot { width:8px; height:8px; border-radius:50%; background:var(--green); animation:pulse-dot 2s infinite; }
.device-dot.off { background:var(--red); animation:none; }
@keyframes pulse-dot { 0%,100%{opacity:1} 50%{opacity:0.4} }
.hdr-btn { background:none; border:1px solid var(--border); color:var(--text-dim); padding:4px 10px; border-radius:6px; font-size:0.75rem; cursor:pointer; transition:all 0.2s; position:relative; font-family:'IBM Plex Sans',sans-serif; }
.hdr-btn:hover { border-color:var(--purple); color:var(--text); }
.inbox-badge { position:absolute; top:-6px; right:-6px; background:var(--orange); color:white; font-size:0.6rem; width:16px; height:16px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:600; }

/* GRID */
.app-grid { display:grid; grid-template-columns:240px 1fr; height:calc(100vh - 50px); overflow:hidden; }

/* SIDEBAR */
.sidebar { background:var(--bg-sidebar); border-right:1px solid var(--border); overflow-y:auto; padding:16px 0; }
.sb-section { padding:0 14px; margin-bottom:20px; }
.sb-title { font-family:'JetBrains Mono',monospace; font-size:0.65rem; color:var(--text-dim); text-transform:uppercase; letter-spacing:1.5px; margin-bottom:10px; padding:0 4px; }
.sb-ws { display:flex; align-items:center; gap:8px; padding:8px 10px; border-radius:8px; cursor:pointer; transition:all 0.15s; font-size:0.88rem; position:relative; }
.sb-ws:hover { background:rgba(255,255,255,0.04); }
.sb-ws.active { background:rgba(108,92,231,0.15); color:var(--text-bright); }
.sb-ws .icon { font-size:1.1rem; }
.sb-ws .name { flex:1; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
.sb-ws .count { font-family:'JetBrains Mono',monospace; font-size:0.65rem; color:var(--text-dim); background:rgba(255,255,255,0.05); padding:2px 6px; border-radius:4px; }
.sb-ws .fire { position:absolute; right:4px; top:4px; font-size:0.7rem; }
.sb-add { display:flex; align-items:center; gap:8px; padding:6px 10px; border-radius:8px; cursor:pointer; color:var(--text-dim); font-size:0.85rem; transition:all 0.15s; }
.sb-add:hover { background:rgba(255,255,255,0.04); color:var(--purple-light); }

/* SIDEBAR: Permanent Links */
.sb-pin-item { display:flex; align-items:center; gap:6px; padding:5px 10px; border-radius:6px; font-size:0.8rem; color:var(--text-dim); transition:all 0.15s; text-decoration:none; cursor:pointer; }
.sb-pin-item:hover { background:rgba(255,255,255,0.04); color:var(--text); }
.sb-pin-item .pin-label { flex:1; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
.sb-pin-item .pin-acts { display:flex; gap:2px; opacity:0; transition:opacity 0.15s; }
.sb-pin-item:hover .pin-acts { opacity:1; }
.pin-btn { background:none; border:none; color:var(--text-dim); cursor:pointer; font-size:0.7rem; padding:2px; }
.pin-btn:hover { color:var(--purple-light); }

/* SIDEBAR: Apps */
.sb-app { display:flex; align-items:center; gap:8px; padding:6px 10px; border-radius:8px; cursor:pointer; font-size:0.85rem; transition:all 0.15s; }
.sb-app:hover { background:rgba(255,255,255,0.04); }
.app-chk { width:16px; height:16px; border:2px solid var(--border); border-radius:4px; display:flex; align-items:center; justify-content:center; font-size:0.65rem; color:transparent; transition:all 0.2s; flex-shrink:0; }
.app-chk.on { background:var(--green); border-color:var(--green); color:white; }
.sb-app .app-name { flex:1; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
.sb-app .app-del { background:none; border:none; color:var(--text-dim); cursor:pointer; font-size:0.7rem; opacity:0; transition:opacity 0.15s; }
.sb-app:hover .app-del { opacity:1; }
.sb-launch-btn { display:block; width:calc(100% - 8px); margin:8px 4px 0; padding:8px; background:linear-gradient(135deg,var(--orange),#e85d04); color:white; border:none; border-radius:8px; font-family:'IBM Plex Sans',sans-serif; font-weight:600; font-size:0.85rem; cursor:pointer; transition:all 0.2s; }
.sb-launch-btn:hover { transform:translateY(-1px); box-shadow:0 4px 16px rgba(253,112,20,0.3); }
.sb-launch-btn:disabled { opacity:0.3; cursor:not-allowed; transform:none; }
.sb-add-row { display:flex; gap:4px; margin-top:6px; padding:0 4px; }
.sb-add-row input { flex:1; padding:5px 8px; background:var(--bg-dark); border:1px solid var(--border); border-radius:6px; color:var(--text); font-size:0.75rem; font-family:'IBM Plex Sans',sans-serif; outline:none; }
.sb-add-row input:focus { border-color:var(--purple); }
.sb-add-row button { padding:5px 8px; background:var(--purple); color:white; border:none; border-radius:6px; font-size:0.75rem; cursor:pointer; }

/* CONTENT */
.content { overflow-y:auto; padding:20px 28px; }
.hypatia-panel { background:var(--hypatia-bg); border:1px solid var(--hypatia-border); border-radius:14px; padding:14px 18px; margin-bottom:20px; display:flex; align-items:flex-start; gap:12px; animation:breathe 4s ease-in-out infinite; }
@keyframes breathe { 0%,100%{border-color:rgba(168,85,247,0.25)} 50%{border-color:rgba(168,85,247,0.45)} }
.hypatia-avatar { width:36px; height:36px; background:linear-gradient(135deg,var(--purple),#ec4899); border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:1rem; flex-shrink:0; }
.hypatia-content { flex:1; }
.hypatia-label { font-family:'JetBrains Mono',monospace; font-size:0.6rem; color:var(--purple-light); text-transform:uppercase; letter-spacing:1px; margin-bottom:4px; }
.hypatia-message { font-size:0.9rem; line-height:1.5; font-weight:300; }
.hypatia-refresh { background:none; border:none; color:var(--purple-light); cursor:pointer; font-size:1rem; opacity:0.5; transition:opacity 0.2s; flex-shrink:0; }
.hypatia-refresh:hover { opacity:1; }

/* Workspace header */
.ws-header { display:flex; align-items:center; justify-content:space-between; margin-bottom:16px; flex-wrap:wrap; gap:8px; }
.ws-header-left { display:flex; align-items:center; gap:10px; }
.ws-header-left .icon { font-size:1.5rem; }
.ws-header-left h2 { font-family:'Playfair Display',serif; font-weight:700; font-size:1.3rem; }
.ws-header-right { display:flex; gap:8px; }
.ws-btn { background:none; border:1px solid var(--border); color:var(--text-dim); padding:5px 12px; border-radius:7px; font-size:0.78rem; cursor:pointer; font-family:'IBM Plex Sans',sans-serif; transition:all 0.2s; }
.ws-btn:hover { border-color:var(--purple); color:var(--text); }
.ws-btn.forge-on { border-color:var(--orange); color:var(--orange); }

/* Items */
.items-label { font-family:'JetBrains Mono',monospace; font-size:0.65rem; color:var(--text-dim); text-transform:uppercase; letter-spacing:1px; margin-bottom:8px; }
.item-row { display:flex; align-items:center; gap:10px; padding:9px 12px; border-radius:8px; transition:background 0.15s; }
.item-row:hover { background:rgba(255,255,255,0.03); }
.item-row.done { opacity:0.35; }
.item-chk { width:18px; height:18px; border:2px solid var(--border); border-radius:5px; cursor:pointer; display:flex; align-items:center; justify-content:center; flex-shrink:0; transition:all 0.2s; color:transparent; font-size:0.7rem; }
.item-chk:hover { border-color:var(--green); }
.item-chk.on { background:var(--green); border-color:var(--green); color:white; }
.item-type { font-size:0.9rem; flex-shrink:0; }
.item-label { flex:1; font-size:0.88rem; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; cursor:pointer; }
.item-label:hover { color:var(--purple-light); }
.item-row.done .item-label { text-decoration:line-through; cursor:default; }
.item-val { font-family:'JetBrains Mono',monospace; font-size:0.65rem; color:var(--text-dim); max-width:180px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
.item-acts { display:flex; gap:2px; opacity:0; transition:opacity 0.15s; }
.item-row:hover .item-acts { opacity:1; }
.i-btn { background:none; border:none; color:var(--text-dim); cursor:pointer; font-size:0.8rem; padding:2px 4px; transition:color 0.15s; }
.i-btn:hover { color:var(--purple-light); }
.i-btn.del:hover { color:var(--red); }

/* Add item form */
.add-row { display:flex; gap:6px; margin-top:10px; padding-top:10px; border-top:1px solid rgba(108,92,231,0.1); }
.add-row select, .add-row input { padding:7px 10px; background:var(--bg-dark); border:1px solid var(--border); border-radius:7px; color:var(--text); font-family:'IBM Plex Sans',sans-serif; font-size:0.82rem; outline:none; }
.add-row select { width:90px; }
.add-row input { flex:1; }
.add-row input:focus, .add-row select:focus { border-color:var(--purple); }
.add-row button { padding:7px 14px; background:var(--purple); color:white; border:none; border-radius:7px; font-weight:600; font-size:0.82rem; cursor:pointer; white-space:nowrap; }

/* Forge */
.forge-section { text-align:center; margin:28px 0 16px; }
.forge-btn { padding:14px 44px; background:linear-gradient(135deg,var(--orange),#e85d04); color:white; border:none; border-radius:12px; font-family:'Playfair Display',serif; font-weight:800; font-size:1.2rem; cursor:pointer; transition:all 0.3s; box-shadow:0 4px 24px rgba(253,112,20,0.3); }
.forge-btn:hover { transform:translateY(-2px); box-shadow:0 8px 32px rgba(253,112,20,0.5); }
.forge-count { font-family:'JetBrains Mono',monospace; font-size:0.75rem; color:var(--text-dim); margin-top:8px; }

/* Empty */
.empty-state { text-align:center; padding:60px 20px; color:var(--text-dim); }
.empty-state .icon { font-size:3rem; margin-bottom:12px; }
.empty-state p { font-size:0.9rem; font-weight:300; line-height:1.6; }

/* MODALS */
.modal-bg { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.6); backdrop-filter:blur(4px); z-index:200; align-items:center; justify-content:center; }
.modal-bg.on { display:flex; }
.modal { background:var(--bg-card); border:1px solid var(--border); border-radius:18px; padding:28px; width:440px; max-width:92vw; max-height:85vh; overflow-y:auto; }
.modal h2 { font-family:'Playfair Display',serif; font-weight:700; font-size:1.2rem; margin-bottom:18px; }
.modal label { display:block; font-size:0.8rem; color:var(--text-dim); margin-bottom:5px; margin-top:12px; }
.modal input, .modal select { width:100%; padding:9px 12px; background:var(--bg-dark); border:1px solid var(--border); border-radius:8px; color:var(--text); font-family:'IBM Plex Sans',sans-serif; font-size:0.88rem; outline:none; }
.modal input:focus { border-color:var(--purple); }
.emoji-picker { display:flex; gap:6px; flex-wrap:wrap; margin-top:6px; }
.emoji-pick { width:34px; height:34px; border-radius:7px; border:1px solid var(--border); background:var(--bg-dark); font-size:1.1rem; cursor:pointer; display:flex; align-items:center; justify-content:center; transition:all 0.2s; }
.emoji-pick:hover, .emoji-pick.sel { border-color:var(--purple); background:rgba(108,92,231,0.15); }
.modal-acts { display:flex; gap:8px; margin-top:20px; justify-content:flex-end; }
.modal-acts button { padding:9px 18px; border-radius:8px; font-family:'IBM Plex Sans',sans-serif; font-weight:600; font-size:0.85rem; cursor:pointer; transition:all 0.2s; }
.btn-x { background:none; border:1px solid var(--border); color:var(--text-dim); }
.btn-x:hover { border-color:var(--text-dim); color:var(--text); }
.btn-ok { background:var(--purple); border:none; color:white; }
.btn-ok:hover { background:var(--purple-dark); }
.btn-del { background:var(--red); border:none; color:white; }

/* Inbox items */
.inbox-row { display:flex; align-items:center; gap:8px; padding:10px; border:1px solid var(--border); border-radius:10px; margin-bottom:8px; background:rgba(255,255,255,0.02); }
.inbox-row .info { flex:1; min-width:0; }
.inbox-row .info .lbl { font-size:0.88rem; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
.inbox-row .info .url { font-family:'JetBrains Mono',monospace; font-size:0.65rem; color:var(--text-dim); overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
.inbox-row select { width:140px; padding:6px 8px; background:var(--bg-dark); border:1px solid var(--border); border-radius:6px; color:var(--text); font-size:0.8rem; flex-shrink:0; }
.inbox-row button { padding:6px 12px; background:var(--green); color:white; border:none; border-radius:6px; font-size:0.8rem; cursor:pointer; flex-shrink:0; font-weight:600; }

/* Toast */
.toast { position:fixed; bottom:20px; right:20px; background:var(--bg-card); border:1px solid var(--green); color:var(--text); padding:10px 18px; border-radius:10px; font-size:0.85rem; z-index:300; transform:translateY(80px); opacity:0; transition:all 0.3s; }
.toast.show { transform:translateY(0); opacity:1; }
.toast.err { border-color:var(--red); }

@media (max-width:700px) {
  .app-grid { grid-template-columns:1fr; }
  .sidebar { display:none; }
  .content { padding:14px; }
  .item-val { display:none; }
}
</style>
</head>
<body>

<!-- LOGIN -->
<div id="loginScreen">
  <div class="login-box">
    <h1>üî® DayForge</h1>
    <p class="sub">Forja tu d√≠a la noche anterior</p>
    <input type="text" id="loginUser" placeholder="Usuario">
    <input type="password" id="loginPass" placeholder="Contrase√±a">
    <button onclick="doLogin()">Entrar</button>
    <div class="login-error" id="loginError"></div>
  </div>
</div>

<!-- APP -->
<div id="appScreen">
  <div class="header">
    <div class="header-left"><span class="header-logo">üî® DayForge</span></div>
    <div class="header-right">
      <button class="hdr-btn" onclick="showInbox()" id="inboxBtn">üì• Inbox <span class="inbox-badge" id="inboxBadge" style="display:none">0</span></button>
      <button class="hdr-btn" onclick="showBookmarklet()">üìé</button>
      <div class="device-status"><div class="device-dot" id="agentDot"></div><span id="agentLabel">...</span></div>
      <button class="hdr-btn" onclick="loadAll()">‚Üª</button>
      <button class="hdr-btn" onclick="doLogout()">Salir</button>
    </div>
  </div>

  <div class="app-grid">
    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
      <div class="sb-section">
        <div class="sb-title">Workspaces</div>
        <div id="sbWorkspaces"></div>
        <div class="sb-add" onclick="openNewWs()">+ Nuevo workspace</div>
      </div>
      <div class="sb-section" id="sbPinSec" style="display:none">
        <div class="sb-title">üìå Permanentes</div>
        <div id="sbPins"></div>
        <div class="sb-add" onclick="addPermanent()">+ Enlace permanente</div>
      </div>
      <div class="sb-section" id="sbAppSec" style="display:none">
        <div class="sb-title">üöÄ Apps</div>
        <div id="sbApps"></div>
        <div class="sb-add-row">
          <input type="text" id="newAppPath" placeholder="Ruta .exe o nombre" onkeydown="if(event.key==='Enter')addApp()">
          <button onclick="addApp()">+</button>
        </div>
        <button class="sb-launch-btn" id="launchBtn" onclick="launchApps()" disabled>üöÄ Lanzar seleccionadas</button>
      </div>
    </div>

    <!-- Content -->
    <div class="content" id="content">
      <div class="hypatia-panel">
        <div class="hypatia-avatar">üíú</div>
        <div class="hypatia-content">
          <div class="hypatia-label">Hypatia observa</div>
          <div class="hypatia-message" id="hypatiaMsg">Cargando...</div>
        </div>
        <button class="hypatia-refresh" onclick="loadHypatia()">‚Üª</button>
      </div>
      <div id="wsContent">
        <div class="empty-state"><div class="icon">üî®</div><p>Selecciona un workspace o crea uno nuevo.<br>Prepara tu d√≠a por la noche. L√°nzalo por la ma√±ana.</p></div>
      </div>
    </div>
  </div>
</div>

<!-- MODAL: Workspace -->
<div class="modal-bg" id="wsModal"><div class="modal">
  <h2 id="wsModalTitle">Nuevo Workspace</h2>
  <label>Nombre</label><input type="text" id="wsName" placeholder="Ej: Goitia, Research..." maxlength="40">
  <label>Icono</label><div class="emoji-picker" id="emojiPicker"></div>
  <input type="text" id="wsIconCustom" placeholder="Emoji" maxlength="2" style="margin-top:6px;width:70px">
  <div class="modal-acts">
    <button class="btn-x" onclick="closeM('wsModal')">Cancelar</button>
    <button class="btn-del" id="wsDelBtn" style="display:none" onclick="deleteWs()">Eliminar</button>
    <button class="btn-ok" onclick="saveWs()">Guardar</button>
  </div>
</div></div>

<!-- MODAL: Edit Item -->
<div class="modal-bg" id="editModal"><div class="modal">
  <h2>Editar Item</h2>
  <label>Tipo</label><select id="eType"><option value="url">üåê URL</option><option value="app">üì± App</option><option value="file">üìÑ Archivo</option><option value="note">üìù Nota</option></select>
  <label>Valor</label><input type="text" id="eValue" placeholder="URL, ruta o nota...">
  <label>Etiqueta</label><input type="text" id="eLabel" placeholder="Nombre descriptivo">
  <label>Mover a workspace</label><select id="eWs"></select>
  <label style="margin-top:14px"><input type="checkbox" id="ePin" style="width:auto;margin-right:6px"> üìå Enlace permanente</label>
  <div class="modal-acts">
    <button class="btn-x" onclick="closeM('editModal')">Cancelar</button>
    <button class="btn-ok" onclick="saveEdit()">Guardar</button>
  </div>
</div></div>

<!-- MODAL: Inbox -->
<div class="modal-bg" id="inboxModal"><div class="modal" style="width:520px">
  <h2>üì• Clasificar Inbox</h2>
  <p style="color:var(--text-dim);font-size:0.85rem;margin-bottom:14px">Asigna cada item a un workspace. Una vez clasificado, desaparece del inbox.</p>
  <div id="inboxItems"></div>
  <div id="inboxEmpty" style="display:none;text-align:center;padding:20px;color:var(--text-dim)"><div style="font-size:2rem;margin-bottom:8px">‚úÖ</div>Inbox vac√≠o</div>
  <div class="modal-acts"><button class="btn-ok" onclick="closeM('inboxModal')">Cerrar</button></div>
</div></div>

<!-- MODAL: Bookmarklet -->
<div class="modal-bg" id="bmModal"><div class="modal">
  <h2>üìé Capturar Tabs</h2>
  <p style="color:var(--text-dim);font-size:0.88rem;margin-bottom:14px;line-height:1.5">Arrastra este bot√≥n a tu <strong>barra de marcadores</strong>. Desde cualquier web, haz click y la URL se captura en tu Inbox.</p>
  <div style="text-align:center;margin:18px 0">
    <a id="bmLink" href="#" style="display:inline-block;padding:10px 22px;background:linear-gradient(135deg,var(--purple),var(--orange));color:white;border-radius:8px;text-decoration:none;font-weight:600;cursor:grab" onclick="event.preventDefault();showToast('Arr√°strame a la barra de marcadores')">üìé + DayForge</a>
  </div>
  <div class="modal-acts"><button class="btn-ok" onclick="closeM('bmModal')">OK</button></div>
</div></div>

<div class="toast" id="toast"></div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DayForge v2.0 ‚Äî Built with ‚àû love by Hypatia & Carles
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const API='';
let TOKEN=localStorage.getItem('dayforge_token')||'';
let workspaces=[], currentWsId=null, currentItems=[];
let editingWsId=null, editingItemId=null, selectedEmoji='üìÅ', selApps=new Set();
const AGENT='http://localhost:5555';
const EMOJIS=['üìÅ','üé®','üî¨','üìù','üíº','üöÄ','üéØ','üìä','üéµ','üìö','üîß','üí°','üåê','üé¨','üì±','üè†','‚ú®','üß†'];
const TI={url:'üåê',app:'üì±',file:'üìÑ',note:'üìù'};
const INBOX='üì• Inbox';

// Auth
async function doLogin(){
  const u=$('loginUser').value,p=$('loginPass').value;
  try{const r=await fetch(`${API}/api/auth/login`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({username:u,password:p})});
  if(!r.ok){$('loginError').textContent='Credenciales incorrectas';return;}
  const d=await r.json();TOKEN=d.token;localStorage.setItem('dayforge_token',TOKEN);showApp();}
  catch(e){$('loginError').textContent='Error de conexi√≥n';}
}
function doLogout(){TOKEN='';localStorage.removeItem('dayforge_token');$('appScreen').style.display='none';$('loginScreen').style.display='flex';}
async function checkAuth(){if(!TOKEN)return false;try{const r=await api('/api/auth/verify');return r.valid;}catch{return false;}}

// API
async function api(path,opts={}){
  const r=await fetch(`${API}${path}`,{...opts,headers:{'Content-Type':'application/json','Authorization':`Bearer ${TOKEN}`,...(opts.headers||{})}});
  if(r.status===401){doLogout();throw new Error('Unauth');}
  if(!r.ok)throw new Error(`API ${r.status}`);return r.json();
}

// Init
async function showApp(){$('loginScreen').style.display='none';$('appScreen').style.display='block';await loadAll();}
async function loadAll(){await loadWsList();checkAgent();loadHypatia();updateBadge();}

// Agent
async function checkAgent(){
  try{const r=await fetch(`${AGENT}/health`,{signal:AbortSignal.timeout(2000)});
  if(r.ok){const d=await r.json();$('agentDot').className='device-dot';$('agentLabel').textContent=d.name||'Conectado';}else throw 0;}
  catch{$('agentDot').className='device-dot off';$('agentLabel').textContent='Sin agente';}
}

// Workspaces list
async function loadWsList(){
  const d=await api('/api/workspaces');workspaces=d.workspaces||[];
  renderSidebar();
  if(currentWsId){const ws=workspaces.find(w=>w.id===currentWsId);if(ws)await selWs(currentWsId);}
  updateBadge();
}

function renderSidebar(){
  $('sbWorkspaces').innerHTML=workspaces.filter(w=>w.status!=='archived'&&w.name!==INBOX)
    .map(w=>`<div class="sb-ws ${w.id===currentWsId?'active':''}" onclick="selWs('${w.id}')">
      <span class="icon">${w.icon||'üìÅ'}</span><span class="name">${esc(w.name)}</span>
      <span class="count">${w.pending_count||0}</span>${w.status==='forged'?'<span class="fire">üî•</span>':''}
    </div>`).join('');
}

async function selWs(id){currentWsId=id;selApps.clear();renderSidebar();await loadContent(id);}

async function loadContent(id){
  const ws=workspaces.find(w=>w.id===id);if(!ws)return;
  const d=await api(`/api/items/${id}`);currentItems=d.items||[];

  const perms=currentItems.filter(i=>i.permanent);
  const pinLinks=perms.filter(i=>i.type==='url'||i.type==='file');
  const apps=perms.filter(i=>i.type==='app');
  const work=currentItems.filter(i=>!i.permanent);
  const pending=work.filter(i=>i.status==='pending');
  const done=work.filter(i=>i.status==='done');

  // Sidebar: pins
  $('sbPinSec').style.display='block';
  $('sbPins').innerHTML=pinLinks.length===0?'<div style="font-size:0.78rem;color:var(--text-dim);padding:4px 10px">Sin enlaces fijos</div>'
    :pinLinks.map(p=>`<div class="sb-pin-item">
      <span style="font-size:0.85rem">${TI[p.type]||'üìÑ'}</span>
      <a href="${esc(p.value)}" target="_blank" class="pin-label" style="color:var(--text-dim);text-decoration:none">${esc(p.label)}</a>
      <div class="pin-acts"><button class="pin-btn" onclick="editItem('${p.id}')" title="Editar">‚úèÔ∏è</button><button class="pin-btn" onclick="unpin('${p.id}')" title="A trabajo">üìã</button></div>
    </div>`).join('');

  // Sidebar: apps
  $('sbAppSec').style.display='block';
  $('sbApps').innerHTML=apps.length===0?'<div style="font-size:0.78rem;color:var(--text-dim);padding:4px 10px">Sin apps</div>'
    :apps.map(a=>`<div class="sb-app" onclick="toggleAppSel('${a.id}')">
      <div class="app-chk ${selApps.has(a.id)?'on':''}">‚úì</div>
      <span class="app-name">${esc(a.label)}</span>
      <button class="app-del" onclick="event.stopPropagation();delItem('${a.id}')" title="Eliminar">‚úï</button>
    </div>`).join('');
  $('launchBtn').disabled=selApps.size===0;

  // Content: workspace
  const forged=ws.status==='forged';
  $('wsContent').innerHTML=`
    <div class="ws-header">
      <div class="ws-header-left"><span class="icon">${ws.icon||'üìÅ'}</span><h2>${esc(ws.name)}</h2></div>
      <div class="ws-header-right">
        <button class="ws-btn ${forged?'forge-on':''}" onclick="toggleForge('${ws.id}',${forged})">${forged?'üî• Forjado':'üî• Marcar hoy'}</button>
        <button class="ws-btn" onclick="openEditWs('${ws.id}')">‚úèÔ∏è</button>
        <button class="ws-btn" onclick="clearDone()">Limpiar ‚úì</button>
      </div>
    </div>
    <div><div class="items-label">üìã Trabajo (${pending.length} pendientes)</div>
    ${pending.length===0&&done.length===0?'<div style="padding:16px;color:var(--text-dim);font-size:0.88rem">Sin items. A√±ade URLs, notas o archivos.</div>':''}
    ${[...pending,...done].map(i=>`<div class="item-row ${i.status==='done'?'done':''}" data-id="${i.id}">
      <div class="item-chk ${i.status==='done'?'on':''}" onclick="toggleSt('${i.id}','${i.status}')">‚úì</div>
      <span class="item-type">${TI[i.type]||'üìÑ'}</span>
      <span class="item-label" onclick="editItem('${i.id}')">${esc(i.label)}</span>
      <span class="item-val">${esc(trn(i.value,35))}</span>
      <div class="item-acts">
        <button class="i-btn" onclick="pin('${i.id}')" title="Fijar">üìå</button>
        <button class="i-btn" onclick="editItem('${i.id}')" title="Editar">‚úèÔ∏è</button>
        <button class="i-btn del" onclick="delItem('${i.id}')" title="Eliminar">‚úï</button>
      </div>
    </div>`).join('')}
    </div>
    <div class="add-row">
      <select id="nType"><option value="url">üåê URL</option><option value="note">üìù Nota</option><option value="file">üìÑ Archivo</option></select>
      <input type="text" id="nValue" placeholder="URL, nota o ruta..." onkeydown="if(event.key==='Enter')addItem()">
      <input type="text" id="nLabel" placeholder="Etiqueta" style="width:120px" onkeydown="if(event.key==='Enter')addItem()">
      <button onclick="addItem()">+ A√±adir</button>
    </div>
    ${forged?`<div class="forge-section"><button class="forge-btn" onclick="forgeDay()">üöÄ FORJAR D√çA</button><div class="forge-count">${pending.length} items + ${apps.length} apps</div></div>`:''}`;
}

// Items CRUD
async function addItem(){
  const t=$('nType').value,v=$('nValue').value.trim(),l=$('nLabel').value.trim();
  if(!v)return;
  await api('/api/items',{method:'POST',body:JSON.stringify({workspace_id:currentWsId,type:t,value:v,label:l,permanent:false,order:999})});
  $('nValue').value='';$('nLabel').value='';await loadContent(currentWsId);await loadWsList();
}
async function toggleSt(id,st){
  await api(`/api/items/${id}`,{method:'PUT',body:JSON.stringify({status:st==='pending'?'done':'pending'})});
  await loadContent(currentWsId);await loadWsList();
}
async function delItem(id){
  await api(`/api/items/${id}`,{method:'DELETE'});await loadContent(currentWsId);await loadWsList();
}
async function pin(id){
  await api(`/api/items/${id}`,{method:'PUT',body:JSON.stringify({permanent:true})});
  await loadContent(currentWsId);showToast('üìå Fijado');
}
async function unpin(id){
  await api(`/api/items/${id}`,{method:'PUT',body:JSON.stringify({permanent:false})});
  await loadContent(currentWsId);showToast('üìã Movido a trabajo');
}
async function clearDone(){
  if(!currentWsId)return;await api(`/api/items/${currentWsId}/clear-done`,{method:'POST'});
  await loadContent(currentWsId);await loadWsList();showToast('Completados limpiados');
}
async function addPermanent(){
  const v=prompt('URL o ruta del enlace permanente:');if(!v)return;
  const l=prompt('Etiqueta:',v.replace('https://','').split('/')[0])||v;
  await api('/api/items',{method:'POST',body:JSON.stringify({workspace_id:currentWsId,type:'url',value:v,label:l,permanent:true,order:0})});
  await loadContent(currentWsId);
}

// App Launcher
function toggleAppSel(id){if(selApps.has(id))selApps.delete(id);else selApps.add(id);loadContent(currentWsId);}
async function addApp(){
  const p=$('newAppPath').value.trim();if(!p)return;
  const l=p.split('\\').pop().split('/').pop().replace('.exe','');
  await api('/api/items',{method:'POST',body:JSON.stringify({workspace_id:currentWsId,type:'app',value:p,label:l,permanent:true,order:0})});
  $('newAppPath').value='';await loadContent(currentWsId);
}
async function launchApps(){
  const apps=currentItems.filter(i=>selApps.has(i.id));let ok=0,agentOk=false;
  try{const r=await fetch(`${AGENT}/health`,{signal:AbortSignal.timeout(2000)});agentOk=r.ok;}catch{}
  if(!agentOk){showToast('Agente local no conectado',1);return;}
  for(const a of apps){
    try{await fetch(`${AGENT}/launch`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({type:'app',path:a.value})});ok++;}catch(e){console.error(e);}
  }
  showToast(`üöÄ ${ok} app${ok>1?'s':''} lanzada${ok>1?'s':''}`);selApps.clear();loadContent(currentWsId);
}

// Forge Day
async function forgeDay(){
  const d=await api('/api/sessions/forge',{method:'POST'});
  const items=d.items_to_launch||[];if(items.length===0){showToast('Nada pendiente',1);return;}
  let ok=0,agentOk=false;
  try{const r=await fetch(`${AGENT}/health`,{signal:AbortSignal.timeout(2000)});agentOk=r.ok;}catch{}

  const urls=items.filter(i=>i.type==='url'&&!i.permanent);
  const apps=items.filter(i=>i.type==='app');

  if(urls.length>0){window.open(urls[0].value,'_blank');ok++;}
  for(let i=1;i<urls.length;i++){await sleep(400);window.open(urls[i].value,'_blank');ok++;}
  if(agentOk){for(const a of apps){try{await fetch(`${AGENT}/launch`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({type:'app',path:a.value})});ok++;}catch{}}}
  showToast(`üöÄ D√≠a forjado ‚Äî ${ok} items lanzados`);setTimeout(()=>loadHypatia(),2000);
}
async function toggleForge(id,on){
  await api(`/api/workspaces/${id}`,{method:'PUT',body:JSON.stringify({status:on?'active':'forged'})});
  await loadWsList();await loadContent(id);
}

// Edit Item
async function editItem(id){
  const i=currentItems.find(x=>x.id===id);if(!i)return;editingItemId=id;
  $('eType').value=i.type;$('eValue').value=i.value;$('eLabel').value=i.label;$('ePin').checked=i.permanent||false;
  $('eWs').innerHTML=workspaces.filter(w=>w.status!=='archived').map(w=>`<option value="${w.id}" ${w.id===currentWsId?'selected':''}>${w.icon} ${esc(w.name)}</option>`).join('');
  openM('editModal');
}
async function saveEdit(){
  if(!editingItemId)return;
  const u={type:$('eType').value,value:$('eValue').value.trim(),label:$('eLabel').value.trim(),permanent:$('ePin').checked};
  if(!u.value){showToast('Valor vac√≠o',1);return;}if(!u.label)u.label=u.value.substring(0,50);
  const nws=$('eWs').value;if(nws!==currentWsId)u.workspace_id=nws;
  await api(`/api/items/${editingItemId}`,{method:'PUT',body:JSON.stringify(u)});
  closeM('editModal');editingItemId=null;await loadContent(currentWsId);await loadWsList();showToast('Item actualizado');
}

// Inbox
async function updateBadge(){
  const inbox=workspaces.find(w=>w.name===INBOX);
  if(inbox&&inbox.pending_count>0){$('inboxBadge').textContent=inbox.pending_count;$('inboxBadge').style.display='flex';}
  else{$('inboxBadge').style.display='none';}
}
async function showInbox(){
  const inbox=workspaces.find(w=>w.name===INBOX);
  if(!inbox){$('inboxItems').innerHTML='';$('inboxEmpty').style.display='block';openM('inboxModal');return;}
  const d=await api(`/api/items/${inbox.id}`);const items=(d.items||[]).filter(i=>i.status==='pending');
  if(items.length===0){$('inboxItems').innerHTML='';$('inboxEmpty').style.display='block';}
  else{
    $('inboxEmpty').style.display='none';
    const opts=workspaces.filter(w=>w.status!=='archived'&&w.name!==INBOX).map(w=>`<option value="${w.id}">${w.icon} ${esc(w.name)}</option>`).join('');
    $('inboxItems').innerHTML=items.map(i=>`<div class="inbox-row" id="ib-${i.id}">
      <div class="info"><div class="lbl">${esc(i.label)}</div><div class="url">${esc(trn(i.value,50))}</div></div>
      <select id="ibs-${i.id}">${opts}<option value="_new">+ Nuevo workspace</option></select>
      <button onclick="classify('${i.id}')">‚Üí</button>
    </div>`).join('');
  }
  openM('inboxModal');
}
async function classify(id){
  const ws=$(`ibs-${id}`).value;
  if(ws==='_new'){const name=prompt('Nombre del nuevo workspace:');if(!name)return;
    const d=await api('/api/workspaces',{method:'POST',body:JSON.stringify({name,icon:'üìÅ',status:'active',order:workspaces.length})});
    await api(`/api/items/${id}`,{method:'PUT',body:JSON.stringify({workspace_id:d.workspace.id})});
  }else{await api(`/api/items/${id}`,{method:'PUT',body:JSON.stringify({workspace_id:ws})});}
  const row=$(`ib-${id}`);if(row)row.remove();
  await loadWsList();updateBadge();
  if(!$('inboxItems').children.length)$('inboxEmpty').style.display='block';
  showToast('‚úÖ Clasificado');
}

// Workspace Modal
function openNewWs(){editingWsId=null;$('wsModalTitle').textContent='Nuevo Workspace';$('wsName').value='';$('wsIconCustom').value='';$('wsDelBtn').style.display='none';selectedEmoji='üìÅ';renderEmoji();openM('wsModal');}
function openEditWs(id){const w=workspaces.find(x=>x.id===id);if(!w)return;editingWsId=id;$('wsModalTitle').textContent='Editar Workspace';$('wsName').value=w.name;$('wsIconCustom').value='';$('wsDelBtn').style.display='inline-block';selectedEmoji=w.icon||'üìÅ';renderEmoji();openM('wsModal');}
function renderEmoji(){$('emojiPicker').innerHTML=EMOJIS.map(e=>`<div class="emoji-pick ${e===selectedEmoji?'sel':''}" onclick="pickEmoji('${e}')">${e}</div>`).join('');}
function pickEmoji(e){selectedEmoji=e;$('wsIconCustom').value='';renderEmoji();}
async function saveWs(){
  const name=$('wsName').value.trim(),icon=$('wsIconCustom').value.trim()||selectedEmoji;
  if(!name){showToast('Nombre requerido',1);return;}
  if(editingWsId){await api(`/api/workspaces/${editingWsId}`,{method:'PUT',body:JSON.stringify({name,icon})});}
  else{const d=await api('/api/workspaces',{method:'POST',body:JSON.stringify({name,icon,status:'active',order:workspaces.length})});currentWsId=d.workspace.id;}
  closeM('wsModal');await loadWsList();if(currentWsId)await loadContent(currentWsId);showToast(editingWsId?'Actualizado':'Workspace creado');
}
async function deleteWs(){
  if(!editingWsId||!confirm('¬øEliminar workspace y todos sus items?'))return;
  await api(`/api/workspaces/${editingWsId}`,{method:'DELETE'});closeM('wsModal');
  if(currentWsId===editingWsId){currentWsId=null;$('wsContent').innerHTML='<div class="empty-state"><div class="icon">üî®</div><p>Selecciona un workspace</p></div>';}
  $('sbPinSec').style.display='none';$('sbAppSec').style.display='none';
  await loadWsList();showToast('Eliminado');
}

// Hypatia
async function loadHypatia(){
  try{const h=new Date().getHours(),ctx=h<14?'morning':h<21?'evening':'night';
  const d=await api('/api/hypatia/observe',{method:'POST',body:JSON.stringify({context:ctx})});
  $('hypatiaMsg').textContent=d.message||'üíú';}catch{$('hypatiaMsg').textContent='Conectando... üíú';}
}

// Bookmarklet
function showBookmarklet(){
  const u=window.location.origin,t=TOKEN;
  $('bmLink').href="javascript:void(function(){var t='"+t+"';fetch('"+u+"/api/quick-add',{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+t},body:JSON.stringify({workspace_id:'inbox',type:'url',value:location.href,label:document.title.substring(0,60)})}).then(function(r){return r.json()}).then(function(d){if(d.item){var n=document.createElement('div');n.textContent='\\u2705 DayForge: '+d.item.label;n.style.cssText='position:fixed;top:12px;right:12px;background:%231a1a2e;color:%23e8e8f0;padding:12px 20px;border:1px solid %236C5CE7;border-radius:10px;z-index:99999;font:14px sans-serif';document.body.appendChild(n);setTimeout(function(){n.remove()},2500)}}).catch(function(e){alert('DayForge: '+e)})})()";
  openM('bmModal');
}

// Utils
function $(id){return document.getElementById(id);}
function openM(id){$(id).classList.add('on');}
function closeM(id){$(id).classList.remove('on');}
function showToast(msg,err){const t=$('toast');t.textContent=msg;t.className=`toast show ${err?'err':''}`;setTimeout(()=>t.className='toast',3000);}
function esc(s){const d=document.createElement('div');d.textContent=s||'';return d.innerHTML;}
function trn(s,n){return(s||'').length>n?s.substring(0,n)+'...':s||'';}
function sleep(ms){return new Promise(r=>setTimeout(r,ms));}

$('loginPass').addEventListener('keydown',e=>{if(e.key==='Enter')doLogin();});
(async()=>{if(await checkAuth())showApp();else $('loginScreen').style.display='flex';})();
</script>
</body>
</html>
